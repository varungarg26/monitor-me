---
image: python:3.7-alpine

services:
  - docker:dind

stages:
  - build
  - test

build_tarball:
  stage: build
  tags:
    - cm-official-docker-executor
  script:
    - apk add --no-cache build-base libffi-dev openssl-dev python3-dev
    - pip install ansible
    - ansible-galaxy collection build --output-path builds/
  artifacts:
    paths:
      - builds/*.tar.gz
  only:
    - merge_requests

test_tarball:
  stage: test
  tags:
    - azure-autoscale-runner
  dependencies:
    - build_tarball
  script:
    - apk add --no-cache build-base libffi-dev openssl-dev python3-dev docker
    - pip install ansible
    - ansible-galaxy collection install ansible.netcommon
    - pip install galaxy-importer
    - export GALAXY_IMPORTER_CONFIG=$CI_PROJECT_DIR/galaxy-importer.cfg
    - python -m galaxy_importer.main builds/$(basename builds/*.tar.gz)
  artifacts:
    when: on_failure
    paths:
      - ./importer_result.json
  only:
    - merge_requests